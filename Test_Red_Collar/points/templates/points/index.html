
    <!DOCTYPE html>
<html>
<head>
    <title>–ö–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; width: 100%; margin-top: 10px; }
        .hidden { display: none; }
        .error { color: red; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="auth-ui">
        <h3 id="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <input type="text" id="user" placeholder="–õ–æ–≥–∏–Ω">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
	<input type="password" id="pass_confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">

        <button id="auth-btn" onclick="handleAuth()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>

        <p onclick="toggleAuth()" style="cursor:pointer; color:blue; text-decoration: underline;">
            <span id="toggle-text">–£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã? –í–æ–π—Ç–∏</span>
        </p>
        <div id="err" class="error"></div>
    </div>

<div id="app-ui" class="hidden">
    <div style="margin-bottom: 10px;">

        <button onclick="getLocation()">üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>

        <input type="number" id="lat-input" placeholder="–®–∏—Ä–æ—Ç–∞ (Lat)" step="any" style="width: 100px;">
        <input type="number" id="lng-input" placeholder="–î–æ–ª–≥–æ—Ç–∞ (Lng)" step="any" style="width: 100px;">
        <input type="number" id="radius-val" placeholder="–†–∞–¥–∏—É—Å (–∫–º)" style="width: 80px;">

        <button onclick="search_in_radius()">–¢–æ—á–∫–∏ –≤ —Ä–∞–¥–∏—É—Å–µ</button>

        <button id="toggle-add-btn" onclick="toggleMapMode()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
        
	<button id="clear-btn" onclick="clearMap()">–û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É</button>

        <button onclick="localStorage.clear(); location.reload()">–í—ã–π—Ç–∏</button>

    </div>
    <div id="map"></div>
</div>


<script>
       
let map;
let markersGroup;
let isLoginMode = false;
let isAddMode = false;
let userLocationMarker = null;

window.onload = () => {
    if (localStorage.getItem('userToken')) {
        document.getElementById('auth-ui').classList.add('hidden');
        document.getElementById('app-ui').classList.remove('hidden');
        initMap();
    }
};

function initMap() {
    if (map) return;
    map = L.map('map').setView([55.75, 37.61], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    markersGroup = L.layerGroup().addTo(map);

    map.on('click', async (e) => {
        if (!isAddMode) return;
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏:");
        if (!name) return;

        const tempMarker = L.marker([e.latlng.lat, e.latlng.lng])
            .addTo(markersGroup)
            .bindPopup("<i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</i>");

        try {
            const res = await fetch('/api/locations/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Token ' + localStorage.getItem('userToken')
                },
                body: JSON.stringify({
                    name: name,
                    location: { type: "Point", coordinates: [e.latlng.lng, e.latlng.lat] }
                })
            });

            if (res.ok) {
                const data = await res.json();
                const locId = data.id;

                let content = `<b>${name}</b><hr>`;
                content += `<div id="comments-list-${locId}"><small>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</small></div><hr>`;
                content += `<textarea id="t-${locId}" style="width:100%" placeholder="–í–∞—à –æ—Ç–∑—ã–≤"></textarea>
                            <button onclick="sendComment(${locId})" style="width:100%">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>`;

                tempMarker.setPopupContent(content);
                alert("–¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
            } else {
                markersGroup.removeLayer(tempMarker);
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞.");
            }
        } catch (err) { 
            markersGroup.removeLayer(tempMarker);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); 
        }
    });
}

function toggleAuth() {
    isLoginMode = !isLoginMode;
    document.getElementById('auth-title').innerText = isLoginMode ? "–í—Ö–æ–¥" : "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
    document.getElementById('auth-btn').innerText = isLoginMode ? "–í–æ–π—Ç–∏" : "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç";
    
    const emailField = document.getElementById('email');
    const passConfirmField = document.getElementById('pass_confirm');
    
    if (emailField) emailField.style.display = isLoginMode ? "none" : "block";
    if (passConfirmField) passConfirmField.style.display = isLoginMode ? "none" : "block";
    
    document.getElementById('err').innerText = "";
}

async function handleAuth() {
    const user = document.getElementById('user').value;
    const pass = document.getElementById('pass').value;
    const errDiv = document.getElementById('err');
    
    if (!user || !pass) {
        errDiv.innerText = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å";
        return;
    }

    const url = isLoginMode ? '/api/login/' : '/api/register/';
    const body = { username: user, password: pass };
    
    if (!isLoginMode) {
        body.email = document.getElementById('email').value;
        body.password_confirm = document.getElementById('pass_confirm').value;
    }

    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        
        const data = await res.json();
        
        if (res.ok) {
            localStorage.setItem('userToken', data.token);
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('app-ui').classList.remove('hidden');
            initMap();
        } else {
            errDiv.innerText = data.error || data.detail || JSON.stringify(data);
        }
    } catch (e) { 
        errDiv.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."; 
    }
}
async function search_in_radius() {
    const lat = document.getElementById('lat-input').value;
    const lng = document.getElementById('lng-input').value;
    const radius = document.getElementById('radius-val').value;

    if (!lat || !lng || !radius) return alert("–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞");

    try {
        const res = await fetch(`/api/nearby/?lat=${lat}&lng=${lng}&r=${radius}`, {
            headers: { 'Authorization': 'Token ' + localStorage.getItem('userToken') }
        });
        const data = await res.json();
        markersGroup.clearLayers();

        L.circle([lat, lng], { radius: radius * 1000, color: 'red', fillOpacity: 0.1 }).addTo(markersGroup);

        data.features.forEach(f => {
            const [pLng, pLat] = f.geometry.coordinates;
            let content = `<b>${f.properties.name}</b><br><small>–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${parseFloat(f.properties.dist).toFixed(2)} –∫–º</small><hr>`;
            content += `<textarea id="t-${f.id}" style="width:100%" placeholder="–í–∞—à –æ—Ç–∑—ã–≤"></textarea>
                        <button onclick="sendComment(${f.id})" style="width:100%">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>`;
            L.marker([pLat, pLng]).addTo(markersGroup).bindPopup(content);
        });
    } catch (e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ—á–µ–∫"); }
}

function getLocation() {
    if (!navigator.geolocation) return alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");

    navigator.geolocation.getCurrentPosition((p) => {
        const lat = p.coords.latitude;
        const lng = p.coords.longitude;
        document.getElementById('lat-input').value = lat.toFixed(6);
        document.getElementById('lng-input').value = lng.toFixed(6);
        
        map.setView([lat, lng], 13);

        if (userLocationMarker) map.removeLayer(userLocationMarker);
        userLocationMarker = L.marker([lat, lng], { zIndexOffset: 1000 }).addTo(map)
            .bindPopup("–í—ã –∑–¥–µ—Å—å").openPopup();
    }, () => alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é"));
}

function toggleMapMode() {
    isAddMode = !isAddMode;
    const btn = document.getElementById('toggle-add-btn');
    if (btn) {
        btn.innerText = isAddMode ? "–†–µ–∂–∏–º: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ" : "–†–µ–∂–∏–º: –ü—Ä–æ—Å–º–æ—Ç—Ä";
        btn.style.backgroundColor = isAddMode ? "#ffcccc" : "";
    }
}

async function sendComment(locId) {
    const inputElement = document.getElementById(`t-${locId}`);

    if (!inputElement) {
     console.error("–ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è ID:", locId);
        return;
     }

     const text = inputElement.value;
     if (!text) return;

try {
    const res = await fetch('/api/comments/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Token ' + localStorage.getItem('userToken')
        },
        body: JSON.stringify({ 
             location: locId, 
	     text: text })
    });

    if (res.ok) { 
        alert("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!");
	inputElement.value = "";
        //document.getElementById(`t-${locId}`).value = "";
        search_in_radius(); 
    } else {
        const data = await res.json();
        //console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", data);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: " + JSON.stringify(data));
    } 
} catch (e) { 
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"); 
}
}
function clearMap() {
    markersGroup.clearLayers();
}
</script>
</body>
</html>